架构核心技术
===

# 交易系统设计的一些原则
### 高并发原则
1. 无状态
应用无状态比较容易进行水平扩展。应用无状态，配置文件有状态，比如不同机房需要读取不同的数据源，此时需要通过配置文件或配置中心指定。比如配置文件odp_settlement/php/etc/ext/ral.ini指定当前是哪个机房。
2. 拆分
系统维度：按照业务或系统功能进行拆分，比如订单系统，商品系统，结算系统等。
功能维度：对一个系统按照功能拆分，比如结算系统分为账务，合同，打款等模块。
读写维度：根据读写比例的特征进行拆分，分别提供读服务和写服务，读服务可以考虑缓存，写服务可以考虑分库分表。
AOP维度：这个不太理解。
模块维度：按照代码维护特征进行拆分。
3. 服务化
单机服务->集群手动注册服务->集群自动注册服务->服务的分组\隔离\路由（流量增大把整个服务打垮）->服务的治理如限流\黑白名单
同时要考虑超时时间(3s)、重试机制(是否需要不断重试)、服务路由（能动态切换不同的分组）、故障补偿等。
4. 消息队列
使用消息队列可以实现服务解耦、异步处理（比如主流程耗时，将无关紧要流程异步处理）、流量削峰（设置nmq消费窗口的大小，如果是拉模式的mq就控制拉去的速度）。其中使用消息队列要注意以下问题：单个消息队列成为瓶颈要考虑镜像复制，是否支持分布式，消费失败怎么处理，重复接收做好幂等性。
大流量缓冲功能：作者以订单系统举例，所说的消息队列是拉模式（跟我们平时用的推模式思维有点不一样，看书的过程一直以为是在说缓存，差点误入歧途）,这里的消息队列有点像缓存表，详情见书上的例子。（这里让我想起了结算openapi中缓存表的使用，在设计缓存表的时候同样要考虑并发处理和重复处理的问题，比如要使用单机串行扫描还是集群扫描，如果集群处理要防止多个集群重复处理一个记录）
数据校对：在使用消息异步机制的场景下，可能存在消息的丢失，需要考虑数据校对和修正，保证数据的一致性和完整性。
5. 数据异构
数据异构：订单表通常按照id分表，如果某个用户查找订单列表，就需要聚合很多表，这时候往往异构一套用户订单表。
数据闭环：如商品详情，数据来源太多，影响系统稳定性的因素就非常多了，最好将数据进行异构存储，生成数据闭环，往往通过MQ进行数据分发，原子化存储到KV存储。
6. 缓存银弹
客户端缓存：浏览器端缓存，如通过响应头参数Expire,Catch-control控制，这种机制适用于对实习性要求不高的数据。app客户端缓存，大促时防止瞬时流量冲击，预先将要用到的素材（js/css/image)下发到客户端，还有首屏数据，app地图也会进行离线缓存。
CDN缓存：将活动页、图片等推到离用户最近的CDN节点，有两种模式，推机制（内容变更时将内容推送到cdn节点）和拉机制（先从边缘节点获取数据，取不到就回源到源数据服务器拉取数据并保存到cdn节点）。使用cdn加速是要注意url的规范，不能包含随机数，不然每次都会穿透到cdn回源到源服务器。
接入层缓存：对于没有使用cdn的应用，可以通过nginx搭建一层接入层。这里不太理解。
应用层缓存：
7. 并发化

#### 高可用原则
1. 降级
	开关集中化管理：通过推送机制把开关推送到各个应用；
	可降级的多级读服务；
	降级开关前置；
	业务降级：当高并发流量来袭，同步改异步，损失强一致性，保证最终一致性。
2. 限流
	防止恶意流量袭击，防止流量超出系统峰值。
3. 切流量
4. 可回滚
#### 业务系统设计原则
1. 防重入，如防止重复扣减库存。
2. 幂等性
3. 流程可定义
4. 状态与状态机
5. 后台系统操作可反馈
6. 后台操作审批化
7. 文档与注释
8. 备份

小结：系统设计时考虑的方面众多：容量规划(流量，容量)、SLA制定(吞吐量、响应时间、可用性)、压测方案、报警监控(响应时间、机器负载)、应急预案(容灾、降级、切流量、可回滚)；

# 高可用性设计
思路：大流量来袭怎么办？上线故障代码怎么办？ 一般接口调用失败？
1. 大流量来袭->负载均衡进行分流->限流或降级
2. 上线鼓掌代码->回滚
3. 如果系统出现问题，要保证不会影响到其他系统，即做好隔离
4. 尽量保证系统不出问题，做好压测
5. 即使系统出现问题要有应对方案，损失降低到最小
6. 对于一般的接口调用失败是否要重试

#### 负载均衡和反向代理
1. 七层协议：应用层、表示层、会话层、传输层(tcp)、网络层（ip）、数据链路层（mac）、物理层
2. nginx用于七层负载均衡（ngx_http_upstream_module),1.90版本开始支持TCP（ngx_stream_upstream_module)四层负载均衡。
3. 负载均衡配置：upstream
4. 负载均衡算法： round-robin、least_conn、hash、ip_hash、least_time
5. 失败重试配置 
6. TCP、HTTP心跳检测
7. HTTP动态负载均衡: Consul + Consul-template
	Consul: 分布式服务注册于发现系统；
	Consul-template:基于Consul自动替换配置文件

#### 限流
#### 降级
#### 回滚
#### 隔离
#### 超时与重试
#### 压测与预案
